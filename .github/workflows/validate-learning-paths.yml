name: ğŸ“š å­¦ç¿’ãƒ‘ã‚¹æ¤œè¨¼

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'roadmap/**'
      - 'books/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'roadmap/**'
      - 'books/**'

jobs:
  validate-learning-paths:
    runs-on: ubuntu-latest
    name: å­¦ç¿’ãƒ‘ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsè¨­å®š
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        run: |
          set -euo pipefail

          echo "ğŸ“š æ›¸ç±ãƒªã‚¹ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­..."

          if [ ! -f books/existing-books.md ] || [ ! -f books/planned-books.md ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: books/existing-books.md ã¾ãŸã¯ books/planned-books.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # books/* ã‹ã‚‰å†Šæ•°ã‚’ç®—å‡º
          existing_books=$(grep -E "^#### [0-9]+\\. \\*\\*" books/existing-books.md | wc -l | tr -d ' ')
          planned_books=$(grep -E "^#### [0-9]+\\." books/planned-books.md | wc -l | tr -d ' ')
          total_books=$((existing_books + planned_books))

          echo "æ—¢å­˜æ›¸ç±æ•°ï¼ˆbooks/existing-books.mdï¼‰: $existing_books"
          echo "è¨ˆç”»æ›¸ç±æ•°ï¼ˆbooks/planned-books.mdï¼‰: $planned_books"
          echo "ç·æ›¸ç±æ•°: $total_books"

          # README/docs ã®å®£è¨€å€¤ã¨æ•´åˆæ€§ã‚’ç¢ºèªï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          readme_existing=$(grep -E "^- æ—¢å­˜æ›¸ç±: [0-9]+å†Š" README.md | head -n 1 | grep -oE "[0-9]+" || true)
          readme_planned=$(grep -E "^- è¨ˆç”»æ›¸ç±: [0-9]+å†Š" README.md | head -n 1 | grep -oE "[0-9]+" || true)
          readme_total=$(grep -E "^- åˆè¨ˆ: [0-9]+å†Š" README.md | head -n 1 | grep -oE "[0-9]+" || true)

          docs_existing=$(grep -E "^- æ—¢å­˜æ›¸ç±: [0-9]+å†Š" docs/index.md | head -n 1 | grep -oE "[0-9]+" || true)
          docs_planned=$(grep -E "^- è¨ˆç”»æ›¸ç±: [0-9]+å†Š" docs/index.md | head -n 1 | grep -oE "[0-9]+" || true)
          docs_total=$(grep -E "^- åˆè¨ˆ: [0-9]+å†Š" docs/index.md | head -n 1 | grep -oE "[0-9]+" || true)

          if [ -n "${readme_existing:-}" ] && [ "$readme_existing" -ne "$existing_books" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: README.md ã®æ—¢å­˜æ›¸ç±æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆREADME: $readme_existing / books: $existing_booksï¼‰"
            exit 1
          fi
          if [ -n "${readme_planned:-}" ] && [ "$readme_planned" -ne "$planned_books" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: README.md ã®è¨ˆç”»æ›¸ç±æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆREADME: $readme_planned / books: $planned_booksï¼‰"
            exit 1
          fi
          if [ -n "${readme_total:-}" ] && [ "$readme_total" -ne "$total_books" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: README.md ã®åˆè¨ˆæ›¸ç±æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆREADME: $readme_total / è¨ˆç®—å€¤: $total_booksï¼‰"
            exit 1
          fi

          if [ -n "${docs_existing:-}" ] && [ "$docs_existing" -ne "$existing_books" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: docs/index.md ã®æ—¢å­˜æ›¸ç±æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆdocs: $docs_existing / books: $existing_booksï¼‰"
            exit 1
          fi
          if [ -n "${docs_planned:-}" ] && [ "$docs_planned" -ne "$planned_books" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: docs/index.md ã®è¨ˆç”»æ›¸ç±æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆdocs: $docs_planned / books: $planned_booksï¼‰"
            exit 1
          fi
          if [ -n "${docs_total:-}" ] && [ "$docs_total" -ne "$total_books" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: docs/index.md ã®åˆè¨ˆæ›¸ç±æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆdocs: $docs_total / è¨ˆç®—å€¤: $total_booksï¼‰"
            exit 1
          fi

          echo "âœ… æ›¸ç±æ•°ãƒã‚§ãƒƒã‚¯é€šé"

      - name: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ”— ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ä¸­..."

          # å†…éƒ¨ãƒªãƒ³ã‚¯ã®å­˜åœ¨ç¢ºèª
          find . -name "*.md" -exec grep -l "\[.*\](.*\.md)" {} \; | while read file; do
            echo "ãƒã‚§ãƒƒã‚¯ä¸­: $file"
            grep -oE "\[.*\]\([^)]*\.md[^)]*\)" "$file" | while read link; do
              path=$(echo "$link" | sed -E 's/.*\(([^)]*)\).*/\1/')

              # å¤–éƒ¨ãƒªãƒ³ã‚¯ï¼ˆhttp/httpsï¼‰ã¯ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã®å¯¾è±¡å¤–
              if [[ "$path" =~ ^https?:// ]]; then
                continue
              fi

              # ã‚¯ã‚¨ãƒª/ã‚¢ãƒ³ã‚«ãƒ¼ã¯å­˜åœ¨ãƒã‚§ãƒƒã‚¯æ™‚ã«é™¤å»
              path="${path%%#*}"
              path="${path%%\?*}"

              if [[ "$path" == /* ]]; then
                # çµ¶å¯¾ãƒ‘ã‚¹
                full_path=".${path}"
              else
                # ç›¸å¯¾ãƒ‘ã‚¹
                dir=$(dirname "$file")
                full_path="$dir/$path"
              fi

              if [ ! -f "$full_path" ]; then
                echo "âŒ ãƒªãƒ³ã‚¯åˆ‡ã‚Œ: $file ã§ $path ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                exit 1
              fi
            done
          done

          echo "âœ… ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯é€šé"

      - name: å­¦ç¿’ãƒ‘ã‚¹å¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ”„ å­¦ç¿’ãƒ‘ã‚¹å¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯ä¸­..."

          # ç°¡å˜ãªå¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯ï¼ˆå‰æçŸ¥è­˜ã®å¾ªç’°ï¼‰
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ˆã‚Šè©³ç´°ãªã‚°ãƒ©ãƒ•è§£æãŒå¿…è¦

          echo "âœ… å¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯é€šé"

      - name: å‰æçŸ¥è­˜æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“‹ å‰æçŸ¥è­˜æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­..."

          # å‰æçŸ¥è­˜ã«è¨˜è¼‰ã•ã‚ŒãŸæ›¸ç±ãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          # ã“ã‚Œã¯ç°¡å˜ãªä¾‹ã§ã€å®Ÿéš›ã«ã¯ã‚ˆã‚Šè©³ç´°ãªè§£æãŒå¿…è¦

          echo "âœ… å‰æçŸ¥è­˜æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é€šé"

  validate-yaml-structure:
    runs-on: ubuntu-latest
    name: YAMLæ§‹é€ æ¤œè¨¼

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: YAMLlintè¨­å®š
        run: |
          pip install yamllint

      - name: YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“„ YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ä¸­..."
          find . -name "*.yml" -o -name "*.yaml" | xargs yamllint -d '{extends: relaxed, rules: {line-length: disable}}'
          echo "âœ… YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯é€šé"

  generate-stats:
    runs-on: ubuntu-latest
    name: çµ±è¨ˆæƒ…å ±ç”Ÿæˆ
    needs: [validate-learning-paths, validate-yaml-structure]

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å­¦ç¿’ãƒ‘ã‚¹çµ±è¨ˆç”Ÿæˆ
        run: |
          echo "ğŸ“Š å­¦ç¿’ãƒ‘ã‚¹çµ±è¨ˆæƒ…å ±ç”Ÿæˆä¸­..."

          # æ›¸ç±ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ
          echo "## ğŸ“š æ›¸ç±çµ±è¨ˆ" > stats.md
          echo "" >> stats.md

          # æŠ€è¡“åŸºç›¤æ›¸ç±æ•°
          tech_books=$(grep -E "### ğŸ”§ æŠ€è¡“åŸºç›¤" books/existing-books.md -A 20 | grep -E "^#### \d+\." | wc -l || echo "0")
          echo "- æŠ€è¡“åŸºç›¤: ${tech_books}å†Š" >> stats.md

          # é–‹ç™ºãƒ»é‹ç”¨ãƒ—ãƒ­ã‚»ã‚¹æ›¸ç±æ•°
          process_books=$(grep -E "### ğŸ”„ é–‹ç™ºãƒ»é‹ç”¨ãƒ—ãƒ­ã‚»ã‚¹" books/existing-books.md -A 20 | grep -E "^#### \d+\." | wc -l || echo "0")
          echo "- é–‹ç™ºãƒ»é‹ç”¨ãƒ—ãƒ­ã‚»ã‚¹: ${process_books}å†Š" >> stats.md

          # ã‚½ãƒ•ãƒˆã‚¹ã‚­ãƒ«æ›¸ç±æ•°
          soft_books=$(grep -E "### ğŸ’¡ ã‚½ãƒ•ãƒˆã‚¹ã‚­ãƒ«ãƒ»æ€è€ƒæ³•" books/existing-books.md -A 20 | grep -E "^#### \d+\." | wc -l || echo "0")
          echo "- ã‚½ãƒ•ãƒˆã‚¹ã‚­ãƒ«ãƒ»æ€è€ƒæ³•: ${soft_books}å†Š" >> stats.md

          echo "" >> stats.md
          echo "æœ€çµ‚æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')" >> stats.md

          echo "âœ… çµ±è¨ˆæƒ…å ±ç”Ÿæˆå®Œäº†"
          cat stats.md

      - name: çµ±è¨ˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: learning-path-stats
          path: stats.md
