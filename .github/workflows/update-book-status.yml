name: ğŸ“– æ›¸ç±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-book-status:
    runs-on: ubuntu-latest
    name: æ›¸ç±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: GitHub CLIè¨­å®š
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
        
    - name: æ—¢å­˜æ›¸ç±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
      run: |
        echo "ğŸ“š æ—¢å­˜æ›¸ç±ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­..."
        
        # æ—¢å­˜æ›¸ç±ãƒªãƒã‚¸ãƒˆãƒªã®çŠ¶æ…‹ã‚’ç¢ºèª
        books=(
          "linux-infra-textbook"
          "IT-infra-book"
          "podman-book"
          "practical-auth-book"
          "github-workflow-book"
          "ai-testing-strategy-book"
          "supabase-architecture-patterns-book"
          "BioinformaticsGuide-book"
          "computational-physicalism-book"
          "negotiation-for-engineers"
          "LogicalThinking-AI-Era-Guide"
          "ai-era-engineers-mind-book"
          "cs-visionaries-book"
        )
        
        > book_status.json
        echo "{" >> book_status.json
        echo "  \"last_updated\": \"$(date -Iseconds)\"," >> book_status.json
        echo "  \"books\": [" >> book_status.json
        
        for i in "${!books[@]}"; do
          book="${books[$i]}"
          echo "ãƒã‚§ãƒƒã‚¯ä¸­: $book"
          
          # ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±å–å¾—
          if repo_info=$(gh api repos/itdojp/$book 2>/dev/null); then
            updated_at=$(echo "$repo_info" | jq -r '.updated_at')
            issues_count=$(gh api repos/itdojp/$book/issues --paginate | jq length)
            stars_count=$(echo "$repo_info" | jq -r '.stargazers_count')
            
            echo "    {" >> book_status.json
            echo "      \"name\": \"$book\"," >> book_status.json
            echo "      \"status\": \"active\"," >> book_status.json
            echo "      \"last_updated\": \"$updated_at\"," >> book_status.json
            echo "      \"issues_count\": $issues_count," >> book_status.json
            echo "      \"stars_count\": $stars_count" >> book_status.json
            
            if [ $i -eq $((${#books[@]} - 1)) ]; then
              echo "    }" >> book_status.json
            else
              echo "    }," >> book_status.json
            fi
          else
            echo "âš ï¸ $book ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"
            echo "    {" >> book_status.json
            echo "      \"name\": \"$book\"," >> book_status.json
            echo "      \"status\": \"unavailable\"," >> book_status.json
            echo "      \"last_updated\": null," >> book_status.json
            echo "      \"issues_count\": 0," >> book_status.json
            echo "      \"stars_count\": 0" >> book_status.json
            
            if [ $i -eq $((${#books[@]} - 1)) ]; then
              echo "    }" >> book_status.json
            else
              echo "    }," >> book_status.json
            fi
          fi
        done
        
        echo "  ]" >> book_status.json
        echo "}" >> book_status.json
        
    - name: é€²æ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "ğŸ“Š é€²æ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’æŠ½å‡º
        total_books=$(jq '.books | length' book_status.json)
        active_books=$(jq '.books | map(select(.status == "active")) | length' book_status.json)
        total_issues=$(jq '.books | map(.issues_count) | add' book_status.json)
        total_stars=$(jq '.books | map(.stars_count) | add' book_status.json)
        
        # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆMarkdownç”Ÿæˆ
        cat > progress_report.md << EOF
# ğŸ“Š IT Engineer Knowledge Architecture é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ

**æ›´æ–°æ—¥æ™‚**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S JST')

## ğŸ“ˆ å…¨ä½“çµ±è¨ˆ

- **ç·æ›¸ç±æ•°**: $total_bookså†Š
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ›¸ç±**: $active_bookså†Š
- **ç·Issueæ•°**: $total_issuesä»¶
- **ç·Staræ•°**: $total_starså€‹

## ğŸ“š æ›¸ç±åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

| æ›¸ç±å | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æœ€çµ‚æ›´æ–° | Issues | Stars |
|--------|------------|----------|--------|-------|
EOF
        
        # å„æ›¸ç±ã®æƒ…å ±ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
        jq -r '.books[] | "| \(.name) | \(.status) | \(.last_updated // "N/A") | \(.issues_count) | \(.stars_count) |"' book_status.json >> progress_report.md
        
        echo "" >> progress_report.md
        echo "## ğŸ¯ ä»Šé€±ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ" >> progress_report.md
        echo "" >> progress_report.md
        echo "- æ–°è¦Issueå¯¾å¿œçŠ¶æ³" >> progress_report.md
        echo "- å­¦ç¿’è€…ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯" >> progress_report.md
        echo "- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•çŠ¶æ³" >> progress_report.md
        
    - name: å¤‰æ›´ãŒã‚ã‚Œã°è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
      run: |
        # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã®ã‚³ãƒŸãƒƒãƒˆ
        if [ -f progress_report.md ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã
          mv progress_report.md docs/progress_report.md
          
          if git diff --quiet docs/progress_report.md; then
            echo "ğŸ“Š é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git add docs/progress_report.md
            git commit -m "ğŸ“Š é€²æ—ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•æ›´æ–°

$(date '+%Y-%m-%d %H:%M:%S JST')

ğŸ¤– Generated with [GitHub Actions]
"
            git push
            echo "âœ… é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          fi
        fi
        
    - name: ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ï¼ˆå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
      run: |
        echo "ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„æ›¸ç±ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        unavailable_count=$(jq '.books | map(select(.status == "unavailable")) | length' book_status.json)
        
        if [ "$unavailable_count" -gt 0 ]; then
          echo "âš ï¸ $unavailable_count å†Šã®æ›¸ç±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"
          
          # Issueä½œæˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
          existing_alert=$(gh issue list --label "alert,book-unavailable" --state open --json number --jq length)
          
          if [ "$existing_alert" -eq 0 ]; then
            unavailable_books=$(jq -r '.books[] | select(.status == "unavailable") | .name' book_status.json)
            
            gh issue create \
              --title "ğŸš¨ æ›¸ç±ã‚¢ã‚¯ã‚»ã‚¹ç•°å¸¸æ¤œå‡º" \
              --label "alert,book-unavailable" \
              --body "ä»¥ä¸‹ã®æ›¸ç±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ:

$unavailable_books

**æ¤œå‡ºæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')
**è‡ªå‹•ç”Ÿæˆ**: GitHub Actions

ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å•é¡ŒãŒè§£æ±ºã•ã‚ŒãŸã‚‰æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚"
          fi
        else
          echo "âœ… ã™ã¹ã¦ã®æ›¸ç±ã¯æ­£å¸¸ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™"
        fi