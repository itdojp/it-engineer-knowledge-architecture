name: ğŸ“– æ›¸ç±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write
  issues: write

jobs:
  update-book-status:
    runs-on: ubuntu-latest
    name: æ›¸ç±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é€²æ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆbook-registryèµ·ç‚¹ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/generate-progress-report.js

      - name: å¤‰æ›´ãŒã‚ã‚Œã°è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
        run: |
          # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã®ã‚³ãƒŸãƒƒãƒˆ
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git diff --quiet docs/progress_report.md; then
            echo "ğŸ“Š é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git add docs/progress_report.md
            git commit -m "ğŸ“Š é€²æ—ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•æ›´æ–°" \
              -m "$(date '+%Y-%m-%d %H:%M:%S JST')" \
              -m "ğŸ¤– Generated with [GitHub Actions]"
            git push
            echo "âœ… é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          fi

      - name: GitHub CLIè¨­å®š
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ï¼ˆå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
        run: |
          echo "ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."

          # ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„æ›¸ç±ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          unavailable_count=$(jq '.books | map(select(.status == "unavailable")) | length' tmp/book_status.json)

          if [ "$unavailable_count" -gt 0 ]; then
            echo "âš ï¸ $unavailable_count å†Šã®æ›¸ç±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"

            # Issueä½œæˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            existing_alert=$(gh issue list --label "alert,book-unavailable" --state open --json number --jq length)

            if [ "$existing_alert" -eq 0 ]; then
              unavailable_books=$(jq -r '.books[] | select(.status == "unavailable") | .name' tmp/book_status.json)
              issue_body_file=$(mktemp)
              {
                echo "ä»¥ä¸‹ã®æ›¸ç±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ:"
                echo ""
                echo "$unavailable_books"
                echo ""
                echo "**æ¤œå‡ºæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')"
                echo "**è‡ªå‹•ç”Ÿæˆ**: GitHub Actions"
                echo ""
                echo "ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å•é¡ŒãŒè§£æ±ºã•ã‚ŒãŸã‚‰æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚"
              } > "$issue_body_file"

              gh issue create \
                --title "ğŸš¨ æ›¸ç±ã‚¢ã‚¯ã‚»ã‚¹ç•°å¸¸æ¤œå‡º" \
                --label "alert,book-unavailable" \
                --body-file "$issue_body_file"

              rm -f "$issue_body_file"
            fi
          else
            echo "âœ… ã™ã¹ã¦ã®æ›¸ç±ã¯æ­£å¸¸ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™"
          fi
